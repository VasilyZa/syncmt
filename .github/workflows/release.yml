name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install musl
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-dev musl-tools g++-multilib
          echo "=== Finding C++ include path ==="
          find /usr/include -name "iostream" 2>/dev/null | head -10
          echo "=== GCC include paths ==="
          g++ -E -x c++ -v - < /dev/null 2>&1 | grep -A 20 "include.*search"
      
      - name: Download and install Clang 22
        run: |
          sudo apt-get install -y aria2
          mkdir -p clang
          cd clang
          aria2c -s16 -x16 --log-level=error https://github.com/ZyCromerZ/Clang/releases/download/22.0.0git-20250928-release/Clang-22.0.0git-20250928.tar.gz
          tar xf Clang-22.0.0git-20250928.tar.gz
          echo "=== Directory Structure ==="
          ls -la
          echo "=== Bin directory contents ==="
          ls -la bin/
          echo "=== Finding clang++ binary ==="
          find . -name "clang++" -type f
          echo "=== Clang Directory Structure ==="
          find . -type d -name "include" | head -20
          echo "CLANG_DIR=$(pwd)" >> $GITHUB_ENV
          echo "$(pwd)/bin" >> $GITHUB_PATH
          echo "=== PATH ==="
          echo $PATH
          echo "=== Clang Version ==="
          clang++ --version
          echo "Clang 22 installed successfully"
      
      - name: Get commit hash
        id: commit
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "Commit hash: ${COMMIT_HASH}"
      
      - name: Build with musl-static
        run: |
          VERSION="${{ inputs.version }}"
          COMMIT="${{ steps.commit.outputs.hash }}"
          BUILD_DATE=$(date +%Y-%m-%d)
          BINARY_NAME="syncmt-${VERSION}-linux-x86_64"
          
          echo "Building version: ${VERSION}"
          echo "Git commit: ${COMMIT}"
          echo "Build date: ${BUILD_DATE}"
          echo "Binary name: ${BINARY_NAME}"
          echo "=== Compiler Info ==="
          ${{ github.workspace }}/clang/bin/clang++ --version
          echo "=== Building ==="
          ${{ github.workspace }}/clang/bin/clang++ \
            -DVERSION="\"${VERSION}\"" \
            -DGIT_COMMIT="\"${COMMIT}\"" \
            -DBUILD_DATE="\"${BUILD_DATE}\"" \
            -static -O2 -std=c++20 \
            --target=x86_64-linux-musl \
            main.cpp -o ${BINARY_NAME}
          ls -lh ${BINARY_NAME}
          file ${BINARY_NAME}
          
          echo "BINARY_NAME=${BINARY_NAME}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "COMMIT=${COMMIT}" >> $GITHUB_ENV
      
      - name: Create Release and Upload Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Creating Release v${{ env.VERSION }} ==="
          
          gh release create v${{ env.VERSION }} \
            --title "Release v${{ env.VERSION }}" \
            --notes "## Release v${{ env.VERSION }}

          ### Build Information
          - **Version**: ${{ env.VERSION }}
          - **Commit**: ${{ env.COMMIT }}
          - **Compiler**: Clang 22 with musl-static
          - **Platform**: Linux x86_64
          - **Build Date**: $(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S UTC+8")

          ### Binary
          - \`${{ env.BINARY_NAME }}\`: Static linked binary for Linux x86_64" \
            ./${{ env.BINARY_NAME }}

name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install musl
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-dev musl-tools g++-multilib dpkg-dev
          echo "=== Finding C++ include path ==="
          find /usr/include -name "iostream" 2>/dev/null | head -10
          echo "=== GCC include paths ==="
          g++ -E -x c++ -v - < /dev/null 2>&1 | grep -A 20 "include.*search"
      
      - name: Download and install Clang 22
        run: |
          sudo apt-get install -y aria2
          mkdir -p clang
          cd clang
          aria2c -s16 -x16 --log-level=error https://github.com/ZyCromerZ/Clang/releases/download/22.0.0git-20250928-release/Clang-22.0.0git-20250928.tar.gz
          tar xf Clang-22.0.0git-20250928.tar.gz
          echo "=== Directory Structure ==="
          ls -la
          echo "=== Bin directory contents ==="
          ls -la bin/
          echo "=== Finding clang++ binary ==="
          find . -name "clang++" -type f
          echo "=== Clang Directory Structure ==="
          find . -type d -name "include" | head -20
          echo "CLANG_DIR=$(pwd)" >> $GITHUB_ENV
          echo "$(pwd)/bin" >> $GITHUB_PATH
          echo "=== PATH ==="
          echo $PATH
          echo "=== Clang Version ==="
          clang++ --version
          echo "Clang 22 installed successfully"
      
      - name: Get commit hash
        id: commit
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "Commit hash: ${COMMIT_HASH}"
      
      - name: Build with musl-static
        run: |
          VERSION="${{ inputs.version }}"
          COMMIT="${{ steps.commit.outputs.hash }}"
          BUILD_DATE=$(date +%Y-%m-%d)
          BINARY_NAME="syncmt-${VERSION}-linux-x86_64"
          
          echo "Building version: ${VERSION}"
          echo "Git commit: ${COMMIT}"
          echo "Build date: ${BUILD_DATE}"
          echo "Binary name: ${BINARY_NAME}"
          echo "=== Compiler Info ==="
          ${{ github.workspace }}/clang/bin/clang++ --version
          echo "=== Building ==="
          ${{ github.workspace }}/clang/bin/clang++ \
            -DVERSION="\"${VERSION}\"" \
            -DGIT_COMMIT="\"${COMMIT}\"" \
            -DBUILD_DATE="\"${BUILD_DATE}\"" \
            -static -O2 -std=c++20 \
            --target=x86_64-linux-musl \
            main.cpp -o ${BINARY_NAME}
          ls -lh ${BINARY_NAME}
          file ${BINARY_NAME}
          
          echo "BINARY_NAME=${BINARY_NAME}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "COMMIT=${COMMIT}" >> $GITHUB_ENV
      
      - name: Create .deb package
        run: |
          VERSION="${{ env.VERSION }}"
          PACKAGE_NAME="syncmt_${VERSION}_amd64.deb"
          
          echo "=== Creating .deb package ==="
          
          mkdir -p package/DEBIAN
          mkdir -p package/usr/local/bin
          mkdir -p package/usr/share/doc/syncmt
          
          cat > package/DEBIAN/control << EOF
Package: syncmt
Version: ${VERSION}
Section: utils
Priority: optional
Architecture: amd64
Maintainer: syncmt contributors
Installed-Size: 1024
Homepage: https://github.com/yourusername/syncmt
Description: High-performance multi-threaded file copy utility
 syncmt is a high-performance, multi-threaded file copy and move utility
 for Linux x86_64. It features:
  - Zero-copy file transfer using sendfile system call
  - Native Linux system calls for directory scanning
  - Pipeline processing for parallel scanning and copying
  - Batch task submission for improved throughput
  - File space pre-allocation with fallocate
  - Adaptive chunk size optimization
  - Directory caching to avoid redundant checks
EOF
          
          cat > package/DEBIAN/postinst << EOF
#!/bin/bash
set -e

echo "syncmt has been installed successfully!"
echo "Usage: syncmt [OPTIONS] <source>... <destination>"
echo "Run 'syncmt -h' for more information."
EOF
          chmod 755 package/DEBIAN/postinst
          
          cp ${{ env.BINARY_NAME }} package/usr/local/bin/syncmt
          chmod 755 package/usr/local/bin/syncmt
          
          cat > package/usr/share/doc/syncmt/README << EOF
syncmt - High-Performance Multi-Threaded File Copy Utility

INSTALLATION
------------
The binary has been installed to /usr/local/bin/syncmt

USAGE
-----
Basic usage:
  syncmt /path/to/source /path/to/destination

Options:
  -t, --threads <num>   Number of threads (default: 4)
  -m, --move            Move files instead of copying
  -v, --verbose         Enable verbose output
  -o, --overwrite       Overwrite existing files
  -s, --skip            Skip existing files
  -h, --help            Show help message
  -V, --version         Print version information

EXAMPLES
--------
Copy a directory:
  syncmt /home/user/documents /backup

Copy with 8 threads:
  syncmt -t 8 /source /destination

Move files:
  syncmt -m /source /destination

PERFORMANCE OPTIMIZATIONS
------------------------
- Zero-copy file transfer using sendfile
- Native Linux system calls (opendir/readdir)
- Pipeline processing for parallel operations
- Batch task submission
- File space pre-allocation
- Adaptive chunk size
- Directory caching

For more information, visit the project repository.
EOF
          
          dpkg-deb --build package ${PACKAGE_NAME}
          ls -lh ${PACKAGE_NAME}
          file ${PACKAGE_NAME}
          
          echo "DEB_PACKAGE=${PACKAGE_NAME}" >> $GITHUB_ENV
      
      - name: Create Release and Upload Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > release_notes.txt << 'EOF'
          ## Release v${{ env.VERSION }}

          ### Build Information
          - **Version**: ${{ env.VERSION }}
          - **Commit**: ${{ env.COMMIT }}
          - **Compiler**: Clang 22 with musl-static
          - **Platform**: Linux x86_64
          - **Build Date**: $(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S UTC+8")

          ### Binaries
          - `${{ env.BINARY_NAME }}`: Static linked binary for Linux x86_64
          - `${{ env.DEB_PACKAGE }}`: Debian package (.deb) for easy installation

          ### Installation
          **Using .deb package (recommended):**
          \`\`\`bash
          sudo dpkg -i ${{ env.DEB_PACKAGE }}
          \`\`\`

          **Using static binary:**
          \`\`\`bash
          chmod +x ${{ env.BINARY_NAME }}
          sudo mv ${{ env.BINARY_NAME }} /usr/local/bin/syncmt
          \`\`\`
          EOF
          
          echo "=== Creating Release v${{ env.VERSION }} ==="
          gh release create v${{ env.VERSION }} \
            --title "Release v${{ env.VERSION }}" \
            --notes-file release_notes.txt \
            ./${{ env.BINARY_NAME }} \
            ./${{ env.DEB_PACKAGE }}

name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install musl
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-dev musl-tools g++-multilib
          echo "=== Finding C++ include path ==="
          find /usr/include -name "iostream" 2>/dev/null | head -10
          echo "=== GCC include paths ==="
          g++ -E -x c++ -v - < /dev/null 2>&1 | grep -A 20 "include.*search"
      
      - name: Download and install Clang 22
        run: |
          sudo apt-get install -y aria2
          mkdir -p clang
          cd clang
          aria2c -s16 -x16 --log-level=error https://github.com/ZyCromerZ/Clang/releases/download/22.0.0git-20250928-release/Clang-22.0.0git-20250928.tar.gz
          tar xf Clang-22.0.0git-20250928.tar.gz
          echo "=== Directory Structure ==="
          ls -la
          echo "=== Bin directory contents ==="
          ls -la bin/
          echo "=== Finding clang++ binary ==="
          find . -name "clang++" -type f
          echo "=== Clang Directory Structure ==="
          find . -type d -name "include" | head -20
          echo "CLANG_DIR=$(pwd)" >> $GITHUB_ENV
          echo "$(pwd)/bin" >> $GITHUB_PATH
          echo "=== PATH ==="
          echo $PATH
          echo "=== Clang Version ==="
          clang++ --version
          echo "Clang 22 installed successfully"
      
      - name: Get commit hash
        id: commit
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "Commit hash: ${COMMIT_HASH}"
      
      - name: Build with musl-static
        run: |
          VERSION="${{ inputs.version }}-${{ steps.commit.outputs.hash }}"
          echo "Building version: ${VERSION}"
          echo "=== Compiler Info ==="
          ${{ github.workspace }}/clang/bin/clang++ --version
          echo "=== Building ==="
          ${{ github.workspace }}/clang/bin/clang++ -static -O2 -std=c++20 --target=x86_64-linux-musl main.cpp -o syncmt-${VERSION}
          ls -lh syncmt-${VERSION}
          file syncmt-${VERSION}
      
      - name: Create Release and Upload Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}-${{ steps.commit.outputs.hash }}"
          echo "=== Creating Release v${VERSION} ==="
          
          gh release create v${VERSION} \
            --title "Release v${VERSION}" \
            --notes "## Release v${VERSION}

          ### Build Information
          - **Version**: ${{ inputs.version }}
          - **Commit**: ${{ steps.commit.outputs.hash }}
          - **Compiler**: Clang 22 with musl-static
          - **Platform**: Linux x86_64
          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ### Binary
          - \`syncmt-${VERSION}\`: Static linked binary for Linux x86_64" \
            ./syncmt-${VERSION}
